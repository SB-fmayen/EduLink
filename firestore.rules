rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funciones de Ayuda (Helpers) ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getRequesterProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isAdmin() {
      return isSignedIn() && getRequesterProfile().data.role == 'admin';
    }

    function isMemberOfSchool(schoolId) {
      return isSignedIn() && getRequesterProfile().data.schoolId == schoolId;
    }
    
    function isTeacherOfCourse(schoolId, courseId) {
      let courseDoc = get(/databases/$(database)/documents/schools/$(schoolId)/courses/$(courseId));
      return isSignedIn() && courseDoc.data.teacherId == request.auth.uid;
    }

    // --- Reglas de Colecciones ---

    match /schools/{schoolId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
      
      match /teachers/{teacherId} {
        allow get, list: if isMemberOfSchool(schoolId);
        allow create, delete: if isAdmin();
      }

      match /students/{studentId} {
        allow get, list: if isMemberOfSchool(schoolId);
        allow create, delete: if isAdmin();
      }

      match /grades/{gradeId} {
        allow get, list: if isMemberOfSchool(schoolId);
        allow create, update, delete: if isAdmin();
      }

      match /sections/{sectionId} {
        allow get, list: if isMemberOfSchool(schoolId);
        allow create, update, delete: if isAdmin();
      }

      match /subjects/{subjectId} {
        allow get, list: if isMemberOfSchool(schoolId);
        allow create, update, delete: if isAdmin();
      }

      match /courses/{courseId} {
        allow get, list: if isMemberOfSchool(schoolId);
        allow create: if isAdmin();
        allow update, delete: if isTeacherOfCourse(schoolId, courseId) || isAdmin();

        match /students/{studentId} {
           allow get, list: if isTeacherOfCourse(schoolId, courseId) || isAdmin() || isOwner(studentId);
           allow create, update, delete: if isTeacherOfCourse(schoolId, courseId) || isAdmin();
        }
      }
    }

    // Regla para la colección de cursos en la raíz
    match /courses/{courseId} {
      allow read: if isSignedIn();
    }

    // --- REGLA DEFINITIVA PARA LA CONSULTA DEL ESTUDIANTE ---
    match /{path=**}/students/{studentDocId} {
        // Esta regla 'read' (get y list) permite que un usuario consulte el grupo de colecciones 'students'.
        // La condición asegura que la consulta SOLO devolverá documentos donde el 'studentId' coincide con el UID del usuario.
        // Como la consulta del cliente (`where('studentId', '==', user.uid)`) y la regla coinciden, Firestore la autoriza.
        allow read: if (isSignedIn() && resource.data.studentId == request.auth.uid) || isAdmin();
    }

    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) || isAdmin();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isOwner(userId) || isAdmin();
    }
  }
}