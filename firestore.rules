rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funciones de Ayuda (Helpers) ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getRequesterProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isStaff() {
      return isSignedIn() && (getRequesterProfile().data.role == 'admin' || getRequesterProfile().data.role == 'director');
    }

    function isAdmin() {
      return isSignedIn() && getRequesterProfile().data.role == 'admin';
    }

    function isMemberOfSchool(schoolId) {
      return isSignedIn() && getRequesterProfile().data.schoolId == schoolId;
    }
    
    function isTeacherOfCourse(schoolId, courseId) {
      return isSignedIn() && get(/databases/$(database)/documents/schools/$(schoolId)/courses/$(courseId)).data.teacherId == request.auth.uid;
    }

    // --- REGLAS PARA COLECCIONES EN LA RAÍZ ---
    match /subjects/{docId} {
      allow read, write: if isStaff();
    }

    match /grades/{docId} {
      allow read, write: if isStaff();
    }
    
    // REGLA AÑADIDA que faltaba
    match /sections/{docId} {
      allow read, write: if isStaff();
    }

    match /courses/{courseId} {
      allow read: if isSignedIn();
      allow write: if isStaff();
    }

    // --- REGLAS PARA COLECCIONES ANIDADAS EN ESCUELAS ---

    match /schools/{schoolId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isStaff();
      
      match /teachers/{teacherId} {
        allow get, list: if isMemberOfSchool(schoolId);
        allow create, delete: if isStaff();
      }

      match /students/{studentId} {
        allow get, list: if isMemberOfSchool(schoolId);
        allow create, delete: if isStaff();
      }

      match /grades/{gradeId} {
        allow get, list: if isMemberOfSchool(schoolId);
        allow create, update, delete: if isStaff();
      }

      match /sections/{sectionId} {
        allow get, list: if isMemberOfSchool(schoolId);
        allow create, update, delete: if isStaff();
      }

      match /subjects/{subjectId} {
        allow get, list: if isMemberOfSchool(schoolId);
        allow create, update, delete: if isStaff();
      }

      match /courses/{courseId} {
        allow get, list: if isMemberOfSchool(schoolId);
        allow create: if isStaff();
        allow update, delete: if isTeacherOfCourse(schoolId, courseId) || isStaff();

        match /students/{studentId} {
           allow get, list: if isTeacherOfCourse(schoolId, courseId) || isStaff() || isOwner(studentId);
           allow create, update, delete: if isTeacherOfCourse(schoolId, courseId) || isStaff();
        }
      }
    }

    // --- REGLA PARA CONSULTA DE ESTUDIANTES ---
    match /{path=**}/students/{studentDocId} {
        allow read: if (isSignedIn() && resource.data.studentId == request.auth.uid) || isStaff();
    }

    // --- REGLAS PARA LA COLECCIÓN DE USUARIOS ---
    match /users/{userId} {
      allow get: if isOwner(userId) || isStaff();
      allow list: if isStaff();
      allow create: if isOwner(userId) || isStaff();
      allow update: if isOwner(userId) || isStaff();
      allow delete: if isOwner(userId) || isStaff();
    }
  }
}
